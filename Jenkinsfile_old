pipeline {
    agent any

    // Parameters allow you to customize the build at runtime
    parameters {
        string(name: 'GITHUB_REPO', defaultValue: 'https://github.com/devatefops/counter-app.git', description: 'GitHub repository URL')
        string(name: 'BRANCH', defaultValue: 'master', description: 'Branch to clone')
        string(name: 'TARGET_HOST', defaultValue: '13.63.34.25', description: 'App server IP') // optional for deploy later
    }

    environment {
        DEPLOY_USER = "deploy"       // The user on the app server
        WORKSPACE_DIR = "workspace"  // Optional workspace subdirectory
    }

    stages {

        stage('Clone Repo on App Server') {
            steps {
                echo "Cloning repo ${params.GITHUB_REPO} on host ${params.TARGET_HOST}"
                // 'server-app-ssh' should be the ID of your SSH private key credential in Jenkins for the TARGET_HOST.
                // This step will use ssh-agent to forward your GitHub SSH key.
                sshagent(credentials: ['server-app-ssh']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${params.TARGET_HOST} \
                        "git clone --branch ${params.BRANCH} ${params.GITHUB_REPO} ${WORKSPACE_DIR}/counter-app"
                    """
                }
            }
        }

        // Placeholder for future build stage
        stage('Build') {
            steps {
                echo "Build stage will go here (e.g., Go binary, Docker build, etc.)"
            }
        }

        // Placeholder for future deploy stage
        stage('Deploy') {
            steps {
                echo "Deploy stage will go here (ssh to ${DEPLOY_USER}@${params.TARGET_HOST})"
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed. Check console log for details."
        }
    }
}
